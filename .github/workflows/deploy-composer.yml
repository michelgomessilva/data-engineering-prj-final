name: Deploy to Cloud Composer

on:
  push:
    branches: [develop]
    paths:
      - 'app/**'
      - 'application/**'
      - 'configs/**'
      - 'dags/**'
      - 'domain/**'
      - 'infrastructure/**'
      - '.github/workflows/deploy-composer.yaml'

env:
  GCP_PROJECT_ID: data-eng-dev-437916
  COMPOSER_BUCKET: europe-west1-airflow-196fdba9-bucket
  CODE_PATH: grupo-2
  APP_ENV: production
  APP_BASE_PATH: /home/airflow/gcs/data/grupo-2
  GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcloud/auth.json

jobs:

  checkout:
    name: Checkout do código
    runs-on: ubuntu-latest
    outputs:
      python-path: ${{ steps.set-path.outputs.python-path }}
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

  setup-gcloud:
    name: Instalar e configurar o Google Cloud
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Instalar Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: gsutil

      - name: Criar credencial local do authorized_user
        run: |
          mkdir -p "${{ github.workspace }}/gcloud"
          echo '${{ secrets.GCLOUD_AUTH_USER_JSON }}' > "${{ github.workspace }}/gcloud/auth.json"

      - name: Autenticar e configurar projeto
        run: |
          gcloud auth application-default login --quiet --scopes=https://www.googleapis.com/auth/cloud-platform \
            --client-id-file="${{ github.workspace }}/gcloud/auth.json" || true
          gcloud auth activate-service-account --key-file="${{ github.workspace }}/gcloud/auth.json" || true
          gcloud config set project $GCP_PROJECT_ID
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcloud/auth.json

  upload-dag:
    name: Upload da DAG para o Composer
    runs-on: ubuntu-latest
    needs: setup-gcloud
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Upload da DAG
        run: |
          gsutil cp dags/pipeline.py gs://$COMPOSER_BUCKET/dags/
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcloud/auth.json

  upload-source:
    name: Upload do código Python para o Composer
    runs-on: ubuntu-latest
    needs: setup-gcloud
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Upload do código fonte
        run: |
          gsutil -m cp -r application gs://$COMPOSER_BUCKET/data/$CODE_PATH/
          gsutil -m cp -r configs gs://$COMPOSER_BUCKET/data/$CODE_PATH/
          gsutil -m cp -r domain gs://$COMPOSER_BUCKET/data/$CODE_PATH/
          gsutil -m cp -r infrastructure gs://$COMPOSER_BUCKET/data/$CODE_PATH/
          gsutil -m cp -r app gs://$COMPOSER_BUCKET/data/$CODE_PATH/
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcloud/auth.json
