name: Deploy to Cloud Composer

on:
  push:
    branches: [develop]
    paths:
      - 'app/**'
      - 'application/**'
      - 'configs/**'
      - 'dags/**'
      - 'domain/**'
      - 'infrastructure/**'
      - '.github/workflows/deploy-composer.yaml'

env:
  GCP_PROJECT_ID: data-eng-dev-437916
  COMPOSER_BUCKET: europe-west1-airflow-196fdba9-bucket
  CODE_PATH: grupo-2
  APP_ENV: production
  APP_BASE_PATH: /home/airflow/gcs/data/grupo-2

jobs:

  checkout:
    name: Checkout do código
    runs-on: ubuntu-latest
    outputs:
      python-path: ${{ steps.set-path.outputs.python-path }}
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

  setup-gcloud:
    name: Instalar e configurar o Google Cloud
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Instalar Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          export_default_credentials: false
          install_components: gsutil

      - name: Criar credencial local do authorized_user
        run: |
          mkdir -p "$HOME/.config/gcloud"
          echo '${{ secrets.GCLOUD_AUTH_USER_JSON }}' > "$HOME/.config/gcloud/application_default_credentials.json"

      - name: Autenticar e configurar projeto
        run: |
          gcloud auth application-default print-access-token
          gcloud config set project $GCP_PROJECT_ID

  upload-dag:
    name: Upload da DAG para o Composer
    runs-on: ubuntu-latest
    needs: setup-gcloud
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Upload da DAG
        run: |
          gsutil cp dags/pipeline.py gs://$COMPOSER_BUCKET/dags/

  upload-source:
    name: Upload do código Python para o Composer
    runs-on: ubuntu-latest
    needs: setup-gcloud
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Upload do código fonte
        run: |
          gsutil -m cp -r application gs://$COMPOSER_BUCKET/data/$CODE_PATH/
          gsutil -m cp -r configs gs://$COMPOSER_BUCKET/data/$CODE_PATH/
          gsutil -m cp -r domain gs://$COMPOSER_BUCKET/data/$CODE_PATH/
          gsutil -m cp -r infrastructure gs://$COMPOSER_BUCKET/data/$CODE_PATH/
          gsutil -m cp -r app gs://$COMPOSER_BUCKET/data/$CODE_PATH/
